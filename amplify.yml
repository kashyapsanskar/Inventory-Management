version: 1

applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing frontend dependencies..."
            - npm ci
        build:
          commands:
            - echo "Building frontend..."
            - npm run build
        postBuild:
          commands:
            - echo "Frontend deployed successfully"
      artifacts:
        files:
          - '**/*'
        baseDirectory: .next
      cache:
        paths:
          - 'node_modules/**/*'

  - appRoot: server
    backend:
      phases:
        preBuild:
          commands:
            - echo "Installing backend dependencies..."
            - cd server && npm ci
            - echo "Checking if Prisma Client is installed..."
            - ls -la server/node_modules/@prisma
            - echo "Generating Prisma Client..."
            - cd server && npx prisma generate

        build:
          commands:
            - echo "Compiling TypeScript..."
            - cd server && npx tsc --noEmit
            - echo "Backend build and Prisma Client generation complete"
        postBuild:
          commands:
            - echo "Backend deployed successfully"  # Ensure no extra spaces here
      artifacts:
        files:
          - '**/*'
      cache:
        paths:
          - 'server/node_modules/**/*'

env:
  variables:
    NODE_VERSION: "16"
    NEXT_PUBLIC_API_BASE_URL: https://45abg15q34.execute-api.ap-south-1.amazonaws.com/prod
